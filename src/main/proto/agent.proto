syntax = "proto3";

option java_multiple_files = true;
option java_package = "bftsmart.rlrpc";

import "google/protobuf/empty.proto";

// Represents the current state
message Report {
    uint32 processed_transactions = 1;
    float avg_message_delay = 2;
    float max_message_delay = 3;
    float min_message_delay = 4;
    float std_message_delay = 5;
}

// Represents the local state
message ReportLocal {
    uint32 node_id = 1;
    uint32 episode = 2;
    Report state = 3;
    optional Reward reward = 4;
    bytes signature = 5;
}

// Reward for a prior episode, sent alongside the next report
message Reward {
    uint32 episode = 1;
    Report report = 2;
    int32 timeout_milliseconds_used = 3;
}

// Batch of signed reports submitted for consensus
message ReportBatch {
    uint32 episode = 1;
    repeated ReportLocal reports = 2;
}

// Timeout recommendation
message Timeout {
    uint32 timeout_milliseconds = 2;
}

// Request a timeout decision for a previously accepted report
message TimeoutRequest {
    uint32 episode = 1;
}

// Status wrapper for async timeout computation
message TimeoutStatus {
    enum Status {
        STATUS_UNSPECIFIED = 0;
        NOT_RECEIVED = 1;
        PENDING = 2;
        READY = 3;
    }
    uint32 episode = 1;
    Status status = 2;
    optional Timeout timeout = 3;
}

// Consensus service
service Consensus {
    // Submit a batch of signed reports for consensus
    rpc SubmitReportBatch(ReportBatch) returns (google.protobuf.Empty);
}

// Learning agent service
service LearningAgent {
    // Send a report to the agent (status via gRPC error codes if rejected)
    rpc SendReport(ReportLocal) returns (google.protobuf.Empty);

    // Poll for timeout recommendation for a previously accepted report
    rpc GetTimeout(TimeoutRequest) returns (TimeoutStatus);

    // Share a report with other agents
    rpc ShareReport(ReportLocal) returns (google.protobuf.Empty);

    // Receive the final agreed reports from consensus
    rpc DeliverConsensus(ReportBatch) returns (google.protobuf.Empty);

    // Reset the agent's internal state/model
    rpc Reset(google.protobuf.Empty) returns (google.protobuf.Empty);
}
